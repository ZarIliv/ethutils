# Extracting and zeroing metadata

The bytecode generated by the Solidity compiler contains so-called metadata that is functionally irrelevant, but contains information like the version of the Solidity compiler (for later versions of the compiler) and a hash identifying the source code.
The metadata is a CBOR2-encoded key-value structure.
A bytecode may contain several of these encoded metadata sections.

`metadata.py` identifies the metadata sections, extracts the metadata and replaces the corresponding sections by zero-bytes.
On the one hand, this helps to access the metadata, e.g. to learn the Solidity version.
On the other hand, when comparing bytecode for functional identity or when running static analysers on the bytecode, it is useful to get the metadata out of the way.

## Required files

```
ethutils/metadata.py
```

## Try it out

The commands below assume that you have set up a virtual environment as described in the topmost [README.md](../../README.md) of the repository.

```bash
cd ethutils/doc/metadata       # go to the directory with the sample code
source ../../venv/bin/activate # activate the virtual environment
xzcat ../section/bytecodes.csv.xz | python wrapper_metadata.py > bytecodes_metadata.csv
deactivate                     # deactivate the virtual environment
```

The file `bytecodes.csv` contains 100 contract codes from Ethereum's main chain as a semicolon-separated text file with header.
Each line contains the fields
```
codeid;account;code
```

`codeid` is a unique identifier for the bytecode.
`account` is one of the addresses on the chain where the code has been deployed.
`code` is the bytecode of the contract.


`bytecodes_metadata.csv` is a semicolon-separated text file with header.
Each line contains the fields
```
codeid;code_wo_meta;solc
```

E.g., the line
```
535998974;0x4a8eae10b7ee97a2c6a6212776f059a25e90e7f4;0x6080604052...0032
```
in `bytecodes.csv` yields the output
```
535998974;0x6080604052...000000;0.5.11
```

## Using the code in a Python program

To process bytecode from within a Python script, use
```python
import ethutils.metadata
code_wo_meta,metas = ethutils.metadata.zeroMetadata(code) # code is a byte string
```
`code_wo_meta` is the original `code` with all metadata sections replaced by zero bytes.
`metas` is a list of Python dictionaries, each of which corresponds to one of the metadata sections found in `code`.
